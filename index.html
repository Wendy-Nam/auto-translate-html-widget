<!-- Tailwind CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- ğŸ§© ì‚¬ìš©ì ì§€ì • ê°€ëŠ¥ í…Œë§ˆ ë³€ìˆ˜ / Customizable Theme Variables -->
<style>
  :root {
    --wrapper-bg: #1f2937;
    /* ë°”íƒ•ìƒ‰ / Background (Slate-800) */
    --wrapper-border: #374151;
    /* í…Œë‘ë¦¬ / Border (Slate-700) */
    --label-color: #f8fafc;
    /* í…ìŠ¤íŠ¸ / Label Text (Slate-50) */
    --btn-bg: #334155;
    /* ë²„íŠ¼ ë°°ê²½ / Button Background (Slate-700) */
    --btn-hover-bg: #475569;
    /* ë²„íŠ¼ hover / Button Hover Background (Slate-600) */
    --btn-text: #f1f5f9;
    /* ë²„íŠ¼ í…ìŠ¤íŠ¸ / Button Text (Slate-100) */
    --btn-active-bg: #fbbf24;
    /* ì„ íƒëœ ë²„íŠ¼ ë°°ê²½ / Active Button Background (Yellow-400) */
    --btn-active-text: #1f2937;
    /* ì„ íƒëœ ë²„íŠ¼ í…ìŠ¤íŠ¸ / Active Button Text (Slate-800) */
  }

  .lang-btn {
    background-color: var(--btn-bg);
    /* ê¸°ë³¸ ë°°ê²½ìƒ‰ / Default background color */
    color: var(--btn-text);
    /* í…ìŠ¤íŠ¸ ìƒ‰ìƒ / Text color */
    transition: all 0.2s ease;
    /* ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ / Smooth transition */
  }

  .lang-btn:hover {
    background-color: var(--btn-hover-bg);
    /* í˜¸ë²„ ì‹œ ë°°ê²½ìƒ‰ / Hover background color */
  }

  .lang-btn.active {
    background-color: var(--btn-active-bg) !important;
    /* í™œì„±í™”ëœ ë²„íŠ¼ ë°°ê²½ / Active button background */
    color: var(--btn-active-text) !important;
    /* í™œì„±í™”ëœ ë²„íŠ¼ í…ìŠ¤íŠ¸ / Active button text */
  }

  .loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    /* ë°˜íˆ¬ëª… ê²€ì • / Semi-transparent black */
    z-index: 50;
    display: flex;
    justify-content: center;
    /* ê°€ìš´ë° ì •ë ¬ (ìˆ˜í‰) / Center horizontally */
    align-items: center;
    /* ê°€ìš´ë° ì •ë ¬ (ìˆ˜ì§) / Center vertically */
  }

  .spinner {
    border-top: 4px solid white;
    /* íŒŒë€ìƒ‰ ìœ— í…Œë‘ë¦¬ / Blue top border */
    border-right: 4px solid transparent;
    /* ì˜¤ë¥¸ìª½ í…Œë‘ë¦¬ëŠ” íˆ¬ëª…í•˜ê²Œ / Transparent right border */
    border-bottom: 4px solid transparent;
    /* ì•„ë˜ìª½ í…Œë‘ë¦¬ íˆ¬ëª…í•˜ê²Œ / Transparent bottom border */
    border-left: 4px solid transparent;
    /* ì™¼ìª½ í…Œë‘ë¦¬ íˆ¬ëª…í•˜ê²Œ / Transparent left border */
    border-radius: 50%;
    /* ì› ëª¨ì–‘ / Circular shape */
    width: 5vw;
    /* ë·°í¬íŠ¸ ë„ˆë¹„ì˜ 5% / Width: 5% of viewport width */
    height: 5vw;
    /* ë„ˆë¹„ì™€ ë™ì¼í•˜ê²Œ ì„¤ì • / Height: same as width for a circle */
    animation: spin 1s linear infinite;
    /* spin ì• ë‹ˆë©”ì´ì…˜ ì ìš© / Apply spin animation */
    z-index: 51;
    /* ì˜¤ë²„ë ˆì´ ìœ„ì— / Above the overlay */
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }

    100% {
      transform: rotate(360deg);
    }
  }

  .hidden {
    display: none;
    /* ìˆ¨ê¹€ / Hidden */
  }
</style>

<!-- ğŸ”’ Google ë²ˆì—­ê¸° ì—˜ë¦¬ë¨¼íŠ¸ (ìˆ¨ê¹€ ì²˜ë¦¬) / Google Translate element (hidden) -->
<div id="google_translate_element" class="hidden"></div>
<script src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

<!-- ğŸŒ ì–¸ì–´ ì„ íƒ UI / Language Switcher UI -->
<div id="lang-switcher" class="max-w-xs mt-4">
  <div class="flex flex-col items-start gap-2 border p-3 shadow-sm rounded"
    style="background-color: var(--wrapper-bg); border-color: var(--wrapper-border);">
    <div class="flex items-center gap-2">
      <!-- í…ìŠ¤íŠ¸ ë¼ë²¨(LANGUAGE)ì— 'notranslate' í´ë˜ìŠ¤ ì ìš© / Prevent label text from being translated -->
      <span class="text-lg">ğŸŒ</span>
      <span class="text-xl font-semibold notranslate" style="color: var(--label-color);">LANGUAGE</span>
    </div>
    <div class="flex flex-wrap gap-2 mt-1">
      <button class="lang-btn rounded px-2.5 py-0.5" data-lang="ko" title="í•œêµ­ì–´">
        <img src="https://tistory4.daumcdn.net/tistory/4029016/skin/images/ko.png" class="h-8 w-8" />
      </button>
      <button class="lang-btn rounded px-2.5 py-0.5" data-lang="en" title="English">
        <img src="https://tistory4.daumcdn.net/tistory/4029016/skin/images/en.png" class="h-8 w-8" />
      </button>
      <button class="lang-btn rounded px-2.5 py-0.5" data-lang="zh-CN" title="ä¸­æ–‡(ç®€ä½“)">
        <img src="https://tistory4.daumcdn.net/tistory/4029016/skin/images/zh-CN.png" class="h-8 w-8" />
      </button>
      <button class="lang-btn rounded px-2.5 py-0.5" data-lang="ja" title="æ—¥æœ¬èª">
        <img src="https://tistory4.daumcdn.net/tistory/4029016/skin/images/ja.png" class="h-8 w-8" />
      </button>
    </div>
  </div>
</div>
<div id="loading-overlay" class="hidden loading-overlay">
  <div class="spinner"></div>
</div>
<!-- ğŸ§  ë™ì‘ ìŠ¤í¬ë¦½íŠ¸ / Behavior Script -->
<script>
  // ğŸŒ Google ë²ˆì—­ ìœ„ì ¯ ì´ˆê¸°í™”
  // EN: Initialize Google Translate widget
  let googleTranslateInitialized = false;
  let googleTranslateReady = false;
  let retryCount = 0;
  const maxRetry = 3; // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ / Max retry attempts

  function loadGoogleTranslate() {
    const script = document.createElement('script');
    script.src = 'https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit';
    script.async = true;
    script.onerror = () => {
      console.error("Google Translate ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨ / Failed to load Google Translate script");
      if (retryCount < maxRetry) {
        retryCount++;
        console.log(`Google Translate ë‹¤ì‹œ ë¡œë“œ ì‹œë„ (${retryCount}/${maxRetry})... / Attempting to reload Google Translate (${retryCount}/${maxRetry})...`);
        setTimeout(loadGoogleTranslate, 3000); // 3ì´ˆ í›„ ì¬ì‹œë„ / Retry after 3 seconds
      } else {
        console.error("Google Translate ë¡œë“œ ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. / Failed to load Google Translate: Max retries exceeded.");
        hideLoading();
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒ ì‚¬í•­) / Optionally display notification to the user
      }
    };
    document.head.appendChild(script);
  }

  function googleTranslateElementInit() {
    try {
      new google.translate.TranslateElement({
        pageLanguage: 'ko', // ê¸°ë³¸ í˜ì´ì§€ ì–¸ì–´ / Default page language
        autoDisplay: false // ìë™ íŒì—… ë¹„í™œì„±í™” / Disable auto popup
      }, 'google_translate_element');
      googleTranslateInitialized = true;
      const checkReadyInterval = setInterval(() => {
        if (document.querySelector('.goog-te-combo')) {
          googleTranslateReady = true;
          reapplyLang();
          clearInterval(checkReadyInterval);
        }
      }, 100);
      setTimeout(() => {
        if (!googleTranslateReady) {
          console.error("Google Translate Element ì´ˆê¸°í™” ì‹¤íŒ¨ / Failed to initialize Google Translate Element");
          if (retryCount < maxRetry) {
            retryCount++;
            console.log(`Google Translate ë‹¤ì‹œ ë¡œë“œ ì‹œë„ (${retryCount}/${maxRetry})... / Attempting to reload Google Translate (${retryCount}/${maxRetry})...`);
            // ìŠ¤í¬ë¦½íŠ¸ ì¬ë¡œë“œë¥¼ í†µí•´ ì´ˆê¸°í™” ì¬ì‹œë„ / Retry initialization by reloading the script
            const scriptToRemove = document.querySelector('script[src*="translate.google.com/translate_a/element.js"]');
            if (scriptToRemove) {
              scriptToRemove.remove();
            }
            loadGoogleTranslate();
          } else {
            console.error("Google Translate ë¡œë“œ ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. / Failed to load Google Translate: Max retries exceeded.");
            hideLoading();
            // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒ ì‚¬í•­) / Optionally display notification to the user
          }
        }
      }, 5000); // 5ì´ˆ íƒ€ì„ì•„ì›ƒ / 5-second timeout
    } catch (error) {
      console.error("Google Translate Element ì´ˆê¸°í™” ì˜¤ë¥˜:", error);
      hideLoading();
      if (retryCount < maxRetry) {
        retryCount++;
        console.log(`Google Translate ë‹¤ì‹œ ë¡œë“œ ì‹œë„ (${retryCount}/${maxRetry})... / Attempting to reload Google Translate (${retryCount}/${maxRetry})...`);
        // ìŠ¤í¬ë¦½íŠ¸ ì¬ë¡œë“œë¥¼ í†µí•´ ì´ˆê¸°í™” ì¬ì‹œë„ / Retry initialization by reloading the script
        const scriptToRemove = document.querySelector('script[src*="translate.google.com/translate_a/element.js"]');
        if (scriptToRemove) {
          scriptToRemove.remove();
        }
        loadGoogleTranslate();
      } else {
        console.error("Google Translate ë¡œë“œ ì‹¤íŒ¨: ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼. / Failed to load Google Translate: Max retries exceeded.");
        hideLoading();
        // ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ (ì„ íƒ ì‚¬í•­) / Optionally display notification to the user
      }
    }
  }

  // ì´ˆê¸° ë¡œë”© ì‹œ Google Translate ë¡œë“œ ì‹œì‘ / Start loading Google Translate on initial load
  loadGoogleTranslate();

  // ì–¸ì–´ì½”ë“œ ì •ê·œí™” í•¨ìˆ˜ (í˜„ì¬ zh-CNë§Œ ì²˜ë¦¬)
  // EN: Normalize language code (currently only for zh-CN)
  const normalizeLangCode = (code) => (code === 'zh-CN' ? 'zh-CN' : code);
  const gtcombo = () => document.querySelector('.goog-te-combo');
  const buttons = document.querySelectorAll('.lang-btn');
  const defaultLang = 'ko';

  // URL íŒŒë¼ë¯¸í„° ì¶”ì¶œ í•¨ìˆ˜
  // EN: Extract query parameter from URL
  const getUrlParam = (name) => {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
  };

  // ì„ íƒëœ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°±ì‹ 
  // EN: Highlight active language button
  const updateStyles = (selected) => {
    buttons.forEach(btn => btn.classList.remove('active'));
    const active = Array.from(buttons).find(b => b.dataset.lang === selected);
    if (active) active.classList.add('active');
  };

  // ë¡œë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ í•¨ìˆ˜
  // EN: Show loading overlay
  const loadingOverlay = document.getElementById('loading-overlay');
  const showLoading = () => {
    loadingOverlay.classList.remove('hidden');
  };
  const hideLoading = () => {
    loadingOverlay.classList.add('hidden');
  };

  // ì–¸ì–´ ì ìš© ì²˜ë¦¬ í•¨ìˆ˜
  // EN: Apply language via dropdown + store in localStorage
  const applyLang = (lang, force = false) => {
    const currentLang = localStorage.getItem('selected-lang');
    if (!force && currentLang === lang) {
      return;
    }

    showLoading(); // ë¡œë”© ì‹œì‘ / Show loading

    // Google ë²ˆì—­ ì…€ë ‰íŠ¸ë°•ìŠ¤ DOM ê°€ì ¸ì˜¤ê¸° / Get Google Translate dropdown DOM
    const combo = gtcombo();
    if (!combo) {
      hideLoading(); // ì½¤ë³´ ë°•ìŠ¤ê°€ ì—†ìœ¼ë©´ ë¡œë”© ìˆ¨ê¹€ / Hide loading if combo box is not available
      updateStyles(currentLang || defaultLang); // í˜„ì¬ ì„ íƒëœ ì–¸ì–´ì— ë§ì¶° ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìœ ì§€ / Maintain button style for the currently selected language
      return;
    }

    combo.value = normalizeLangCode(lang); // ì…€ë ‰íŠ¸ë°•ìŠ¤ ê°’ ë³€ê²½ / Change dropdown value
    combo.dispatchEvent(new Event('change')); // ë³€ê²½ ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±° / Trigger change event
    localStorage.setItem('selected-lang', lang); // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ ì €ì¥ / Store in localStorage
    updateStyles(lang); // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ê°±ì‹  / Update button style

    // ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë¡œë”© ì¢…ë£Œ (ë²ˆì—­ì´ ë°”ë¡œ ì ìš©ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
    // EN: End loading after a short delay (as translation may not be immediate)
    setTimeout(hideLoading, 500);
  };

  // ì´ˆê¸° ì–¸ì–´ ì ìš© ì‹œë„
  // EN: Attempt to apply initial language
  const applyInitialLang = () => {
    const urlLang = getUrlParam('lang'); // ?lang=xx URL íŒŒë¼ë¯¸í„° / ?lang=xx URL parameter
    const storedLang = localStorage.getItem('selected-lang');
    const initialLang = urlLang || storedLang || defaultLang;
    updateStyles(initialLang);
    if (googleTranslateReady) {
      applyLang(initialLang, true);
    }
  };

  // í˜ì´ì§€ ìƒíƒœ ë³€ê²½ ì‹œ ì–¸ì–´ ì¬ì ìš©
  // EN: Re-apply language on page state change
  const reapplyLang = () => {
    const storedLang = localStorage.getItem('selected-lang');
    if (storedLang) {
      updateStyles(storedLang);
      if (googleTranslateReady) {
        applyLang(storedLang, true);
      }
    } else {
      applyInitialLang();
      // localStorageì— ì—†ìœ¼ë©´ URL íŒŒë¼ë¯¸í„° ë˜ëŠ” ê¸°ë³¸ ì–¸ì–´ ì ìš©
      // If not in localStorage, apply from URL parameter or default language
    }
  };

  window.addEventListener('load', () => {
    // Google Translate Elementê°€ ì´ˆê¸°í™”ëœ í›„ì— ì´ˆê¸° ì–¸ì–´ ì ìš© ì‹œë„
    // EN: Attempt initial language application after Google Translate Element is initialized
    const checkInitInterval = setInterval(() => {
      if (googleTranslateInitialized) {
        clearInterval(checkInitInterval);
      }
    }, 100); // 100ms ê°„ê²©ìœ¼ë¡œ í™•ì¸ / Check every 100ms
  });
  window.addEventListener('popstate', reapplyLang);

  // pushState / replaceState ê°ì§€ í›„ ì–¸ì–´ ì¬ì ìš©
  // EN: Re-apply language after pushState / replaceState
  const interceptHistoryChange = (fnName) => {
    const original = history[fnName];
    history[fnName] = function () {
      original.apply(this, arguments);
      reapplyLang();
    };
  };

  interceptHistoryChange('pushState');
  interceptHistoryChange('replaceState');

  // ê° ì–¸ì–´ ë²„íŠ¼ í´ë¦­ ì‹œ ì–¸ì–´ ì „í™˜
  // EN: Language button click event
  buttons.forEach(btn => {
    btn.addEventListener('click', () => {
      const toLang = btn.dataset.lang;
      applyLang(toLang, true);
    });
  });
</script>